# 容错性测试计划 - 数据库中断测试

## 测试项目信息
- **项目名称**: Flask支付服务容错性测试
- **测试类型**: 容错性测试（数据库中断）
- **测试环境**: VS Code + Docker
- **测试工具**: Python + Requests + Docker SDK
- **测试时间**: 2025年11月
- **测试负责人**: [姓名]

## 测试目标
验证Flask支付服务在数据库中断情况下的容错能力，包括：
1. 数据库中断时的错误处理能力
2. 数据库恢复后的服务恢复能力
3. 支付过程中数据库中断的处理机制
4. 重试机制的有效性
5. 数据一致性保障

## 测试环境配置

### 技术栈
- **Web框架**: Flask 2.0.1
- **数据库**: PostgreSQL 13
- **ORM**: SQLAlchemy 2.5.1
- **容器化**: Docker + Docker Compose
- **测试工具**: Python 3.9 + pytest + requests

### 服务架构
```
┌─────────────┐     ┌─────────────┐
│  Flask Web  │────▶│ PostgreSQL  │
│  Service    │◀────│ Database    │
└─────────────┘     └─────────────┘
```

### 环境变量配置
```bash
# Flask应用配置
FLASK_APP=app.py
FLASK_ENV=production
FLASK_HOST=0.0.0.0
FLASK_PORT=5000

# 数据库配置
DATABASE_URL=postgresql://postgres:postgres@db:5432/payment_db

# 容错配置
PAYMENT_RETRY_ATTEMPTS=3
PAYMENT_RETRY_DELAY=2
```

## 测试用例设计

### 测试用例1: 正常操作流程测试
**测试ID**: FT-001  
**测试类型**: 功能测试  
**优先级**: 高  
**测试目标**: 验证服务在正常情况下的基本功能

**测试步骤**:
1. 启动所有服务（Flask + PostgreSQL）
2. 调用健康检查接口 `/health`
3. 调用支付创建接口 `/payment`
4. 调用支付查询接口 `/payment/{order_id}`
5. 验证所有操作成功

**预期结果**:
- 健康检查返回状态为 `healthy`
- 支付创建成功，返回201状态码
- 支付查询成功，返回正确的支付信息

### 测试用例2: 支付过程中数据库中断测试
**测试ID**: FT-002  
**测试类型**: 容错性测试  
**优先级**: 最高  
**测试目标**: 验证支付过程中数据库突然中断的处理能力

**测试步骤**:
1. 启动所有服务并确保正常运行
2. 开始创建支付请求
3. 在请求处理过程中立即停止数据库容器
4. 观察支付请求的响应
5. 重启数据库容器
6. 等待服务恢复后检查数据一致性

**预期结果**:
- 支付请求应该失败并返回适当的错误信息
- 服务应该能够正确处理数据库中断
- 数据库恢复后服务应该自动恢复
- 数据应该保持一致性（未完成的支付不应该被保存）

### 测试用例3: 数据库断开时的支付请求测试
**测试ID**: FT-003  
**测试类型**: 容错性测试  
**优先级**: 高  
**测试目标**: 验证数据库已断开时服务的错误处理能力

**测试步骤**:
1. 启动所有服务并确保正常运行
2. 停止数据库容器
3. 等待10秒确保数据库完全停止
4. 尝试创建支付请求
5. 检查错误响应
6. 重启数据库容器
7. 验证服务恢复正常

**预期结果**:
- 支付请求应该立即失败
- 返回503 Service Unavailable状态码
- 错误信息应该清晰指示数据库连接问题
- 数据库恢复后服务应该正常工作

### 测试用例4: 重试机制测试
**测试ID**: FT-004  
**测试类型**: 容错性测试  
**优先级**: 中  
**测试目标**: 验证服务的自动重试机制

**测试步骤**:
1. 启动所有服务并确保正常运行
2. 临时停止数据库容器（2秒）
3. 在数据库停止期间创建支付请求
4. 立即恢复数据库容器
5. 观察支付请求是否成功
6. 检查日志验证重试机制是否生效

**预期结果**:
- 支付请求应该在重试几次后成功
- 日志中应该有重试相关的记录
- 最终支付应该成功创建
- 数据一致性应该得到保证

## 测试执行计划

### 测试准备阶段
1. **环境搭建** (30分钟)
   - 安装Docker和Docker Compose
   - 配置Python虚拟环境
   - 安装测试依赖包
   - 验证环境配置

2. **测试数据准备** (15分钟)
   - 创建测试数据库
   - 准备测试用例数据
   - 配置日志记录

### 测试执行阶段
1. **FT-001 正常操作流程测试** (15分钟)
2. **FT-002 支付过程中数据库中断测试** (30分钟)
3. **FT-003 数据库断开时的支付请求测试** (25分钟)
4. **FT-004 重试机制测试** (20分钟)

### 测试总结阶段
1. **结果分析** (20分钟)
2. **报告生成** (15分钟)
3. **问题总结** (10分钟)

## 测试工具和脚本

### 自动化测试脚本
`test_fault_tolerance.py` - 包含所有测试用例的自动化脚本

### 关键功能模块
1. **Docker服务管理**
   - 启动/停止/重启容器
   - 健康检查
   - 日志收集

2. **API测试客户端**
   - 支付创建
   - 支付查询
   - 健康检查

3. **测试结果分析**
   - JSON格式报告
   - HTML可视化报告
   - 测试覆盖率统计

## 风险评估和应对措施

### 潜在风险
1. **测试环境不稳定**
   - 风险等级: 中
   - 应对措施: 增加重试机制，延长等待时间

2. **Docker命令执行失败**
   - 风险等级: 低
   - 应对措施: 增加错误检查和手动干预选项

3. **网络延迟影响测试结果**
   - 风险等级: 中
   - 应对措施: 动态调整等待时间，增加超时处理

### 应急处理
- **测试卡死**: 使用 `docker-compose down` 强制清理环境
- **数据库损坏**: 重新初始化数据库 `docker volume prune`
- **端口冲突**: 修改配置文件中的端口映射

## 测试交付物

### 必需交付物
1. **测试计划文档** - 本文档
2. **自动化测试脚本** - `test_fault_tolerance.py`
3. **测试报告** - JSON和HTML格式
4. **测试日志** - 详细的执行日志

### 可选交付物
1. **性能分析报告**
2. **代码覆盖率报告**
3. **问题跟踪清单**

## 成功标准

### 功能要求
- 所有测试用例执行完成
- 核心功能测试通过率100%
- 容错性测试通过率≥80%

### 质量要求
- 测试报告完整准确
- 问题描述清晰可复现
- 测试过程可重复

### 文档要求
- 测试计划文档完整
- 测试用例设计合理
- 测试结果分析详细

## 附录

### Docker Compose配置
详见 `docker-compose.yml`

### API接口文档
1. **健康检查**
   - URL: `/health`
   - 方法: GET
   - 返回: 服务状态和数据库连接状态

2. **创建支付**
   - URL: `/payment`
   - 方法: POST
   - 请求体: `{"order_id": "string", "amount": number}`
   - 返回: 创建的支付信息

3. **查询支付**
   - URL: `/payment/{order_id}`
   - 方法: GET
   - 返回: 支付详细信息

### 故障模拟命令
```bash
# 停止数据库容器
docker stop fault_tolerance_test_db_1

# 启动数据库容器
docker start fault_tolerance_test_db_1

# 查看容器日志
docker logs -f fault_tolerance_test_web_1
```

---
**文档版本**: 1.0  
**创建日期**: 2025年11月20日  
**最后更新**: 2025年11月20日